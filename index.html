<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Mood tracker</title>
    </head>
    <body>
      <h1>Mood tracker</h1>

      <strong>Status:</strong><span id="status"></span><br/>

      <strong>Liczba podłączonych:</strong><span id="clients"></span><br/>

      <table>
        <tr>
          <td><strong>Mood</strong></td>
          <td><a href="#" onclick="setMood('sad')">Sad</a></td>
          <td><a href="#" onclick="setMood('content')">Content</a></td>
          <td><a href="#" onclick="setMood('happy')">Happy</a></td>
        </tr>
        <tr id="my-mood">
          <td><strong>I am</strong></td>
          <td></td>
          <td>x</td>
          <td></td>
        </tr>
        <tr id="others-mood">
          <td><strong>Others are</strong></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </table>

      <script type="text/javascript">
        var moods = [
          'sad',
          'content',
          'happy'
        ],
        myMood = 'content',
        connection = new WebSocket("ws://localhost");

        function setStatus(txt,el) {
          el = el || 'status';
          document.getElementById(el).textContent = txt;
        };

        function setMood(mood) {
          var tds = document.getElementById('my-mood').getElementsByTagName('td'),
          i = tds.length-1;
          for (;i>=1;i--) {
            if (i-1 == moods.indexOf(mood))
              tds[i].textContent = 'x';
            else
              tds[i].textContent = '';
          }
          myMood = mood;
          connection.send(JSON.stringify({type:'moodtracker.change',moodName:myMood}));
        }

        function updateMoodStats(stats) {
          var tds = document.getElementById('others-mood').getElementsByTagName('td'),
          i = tds.length-1,
          mood;
          for (;i>=1;i--) {
            mood = moods[i-1];
            tds[i].textContent = stats[mood];
          }
        }

        connection.onopen = function() {
          setStatus('Connected');
          connection.send(JSON.stringify({type:'moodtracker.change',moodName:myMood}));
        };
        connection.onerror = function(error) {
          setStatus('Error');
        };
        connection.onmessage = function(e) {
          var data = JSON.parse(e.data);

          setStatus('Got message: '+e.data);
          if (data.type == 'moodtracker.status') {
            setStatus(data.clientsCount,'clients');
            updateMoodStats(data.moods);
          }

        };
      </script>
    </body>
</html>
